<!--
`rpg-entity` is the custom element that represents a playable entity.

Example:
    <rpg-entity tyle="player"></rpg-entity>


@element rpg-entity
@blurb This is the custom element that represents a playable entity.
@author Wassim Chegham
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="rpg-entity" attributes="type">
  <template>
		<style>
			:host {
			  position: absolute;
			  cursor: pointer;
			  transition: left 0.5s linear,top 0.5s linear;
		    transform: translateZ(0);
			}
			:host .rpg-entity:hover img {
			  transform: scale(1.2);
			}
			:host .rpg-entity:hover span {
			  opacity: 1;
			}
			:host .rpg-entity {
			  width: 32px;
			  height: 32px;
			}
			:host .rpg-entity span {
			  opacity: 0.1;
			  transition: opacity 0.1s linear;
			  position: relative;
		    margin-left: -14px;
  			margin-top: 14px;
			}
			:host .rpg-entity img {
			  vertical-align: top;
			  transition: transform 0.1s linear;
			  cursor: pointer;
			}
			:host .rpg-entity .rpg-name {
			  z-index: 10;
			  font-weight: bolder;
			  font-size: 10px;
			  display: inline-block;
			  width: 60px;
			  border: 1px solid;
			  background-color: white;
			  border-radius: 4px;
			  top: -40px;
			  left: 0;
			  position: absolute;
			}
			:host .rpg-entity .rpg-life {
			  z-index: 10;
			  border: 1px solid;
			  display: inline-block;
			  width: 60px;
			  height: 8px;
			  border-radius: 4px;
			  overflow: hidden;
			  position: absolute;
			  background-color: white;
			  left: 0;
			  bottom: -15px;
			}
			:host .rpg-entity .rpg-life i {
			  background-color: lime;
			  width: 100%;
			  height: 8px;
			  display: inline-block;
			  margin: 0;
			  padding: 0;
			  position: absolute;
			  top: 0;
			  left: 0;
			  transition: width 1s;
			}
			:host .rpg-entity.collide {
			  animation-name: collide;
			  animation-duration: 0.1s;
			  animation-iteration-count: 2;
			}

			@keyframes collide {
			  0% {
			    margin-left: 5px;
			  }
			  50% {
			    margin-left: -5px;
			  }
			  100% {
			    margin-left: 0;
			  }
			}

		</style>
	  <div class="rpg-entity" data-x="{{entity.position.x}}" data-y="{{entity.position.y}}">
	  	<span class="rpg-life"><i style="width:{{entity.life}%;"></i></span>
	  	<span class="rpg-name">{{entity.name}}</span>
	  	<img src="{{entity.avatar}}" width="32px" height="32px"/>
	  </div>
	</template>
  <script>
    Polymer({
    	publish : {
    		type: 'player'
    	},
    	entity: {
	    	name: '',
	    	life: 100,
	    	avatar: '',
	    	position: {
	    		current: {
	    			x: 0,
	    			y: 0
	    		},
	    		previous: {
	    			x: 0,
	    			y: 0
	    		}
	    	}
    	},
    	typeChanged: function(oldValue, newValue){
    		this.domready();
    	},
    	collide: function(){
  		  this.classList.add('collide');
		    setTimeout(function() {
		      this.classList.remove('collide');
		    }.bind(this), 1000);
    	},
    	transpose: function(loc){
    		this.style.top = loc.top + 17 + 'px',
    		this.style.left = (loc.left + 53) + 'px'
    	},
    	moveTo: function(cell){
    		this.transpose(cell.location);
    		this.entity.position = cell.position;
    	},
    	setEntity: function(data){

    		try {
    			this.entity.name = data.player.playerInfo.name;
    			this.entity.avatar = data.player.playerInfo.avatar;
    			this.entity.life = data.player.life;
    			this.entity.position.previous = data.newCell;
    			this.entity.position.current = data.newCell;
    		}
    		catch(e){
    			// ignore missing properties, we took them from the parent prototype
    		}

    		this.dataset.x = this.entity.position.current.x;
    		this.dataset.y = this.entity.position.current.y;

    		return this;

    	},
    	domready: function(){
    		try {
					this.entity = RPG.Factory[this.type]();
    		}
    		catch(e){
    			console.error('The entity type "'+this.type+'" is not valid. Here is the stack trace...');
    			console.trace();
    		}
    	},
    	ready: function(){
    		// expose internal properties as attributes, so no need for setters/getters.
    		Polymer.mixin(this, this.entity);
    	}
    });
  </script>
</polymer-element>